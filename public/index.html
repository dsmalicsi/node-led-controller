<!DOCTYPE HTML>
<!-- 
 Copyright (C) 2016 Daryll Malicsi,
 LICENSE at https://github.com/dsmalicsi/node-led-controller/blob/master/LICENSE.md
-->
<html>

<head>
    <title>Node-Led-Controller by @dsmalicsi</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">


    <title>Bootstrap Material</title>

    <!-- Material Design fonts -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Material Design -->
    <link href="css/bootstrap-material-design.css" rel="stylesheet">
    <link href="css/ripples.min.css" rel="stylesheet">
    <link href="css/wheelcolorpicker.css" rel="stylesheet">
    <link href="css/wheelcolorpicker.dark.css" rel="stylesheet">
    <link href="css/snackbar.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        .snackbar.success {
            background-color: #5cb85c;
        }
        
        .snackbar.error {
            background-color: #f55549;
        }
        
        .snackbar.info {
            background-color: #0fb2fc;
        }
        
        .noUi-tooltip {
            margin-top: 18px;
        }
        
        .panel-body {
            background-color: #424242 !important;
        }
        
        .btn-on {
            background-color: #03a9f4 !important;
        }
        
        .btn-off {
            background-color: rgba(153, 153, 153, 0.2) !important;
        }
        
        h4 .material-icons {
            font-size: 22px !important;
            vertical-align: bottom;
        }
        
        .jQWCP-wWidget.jQWCP-block {
            border: 0px;
            background: 0px;
            box-shadow: none;
        }
        
        .form-inline input.form-control {
            display: block;
            color: #FFF !important;
        }
        /*
        .togglebutton {
            margin-left: 5px;
        }
*/
    </style>

</head>

<body class="inverse">

    <div class="container">
        <div class="page-header" id="banner">
            <div class="row">
                <div class="col-sm-12">
                    <h1>node-led-controller</h1>
                    <p class="lead">This is the front-end panel of the <a href="https://nodejs.org/en/">Node.js</a> client for controlling and programming LED Lights connected to a <a href="http://nodemcu.com/index_en.html">NodeMCU</a> WiFi chipset. This panel uses <a href="http://socket.io/">Socket.io</a> as a bridge between the user and the devices for real-time event-based communication.</p>
                </div>

            </div>
        </div>

        <div class="row device-container" id="192_168_1_50">

            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4>
                            <i id="connect-ok" class="material-icons text-success">wifi</i> 
                            <i id="connect-remote" class="material-icons text-success">wb_cloudy</i> 
                            <i id="connect-warn" class="material-icons text-warning">perm_scan_wifi</i> 
                            <i id="connect-off" class="material-icons text-muted">signal_wifi_off</i>  
                            <b>DEVICE 1</b> (<span id="device-ip">192.168.1.50</span>:<span id="device-port">5577</span>)
                        </h4>
                    </div>
                    <div class="panel-body">
                        <div class="col-xs-3 col-sm-2 col-md-1">


                            <label>Power</label>
                            <div id="control-power" class="togglebutton btn-group-sm">
                                <a href="javascript:void(0)" id="btn-power" class="btn btn-info btn-fab">
                                    <i class="material-icons">power_settings_new</i>
                                    <input id="btn-power-value" name="btn-power-value" type="checkbox" class="hidden" checked>

                                </a>
                            </div>

                        </div>

                        <div id="control-brightness" class="col-xs-9 col-sm-6 col-md-4">
                            <label>Brightness: <span id="level-brightness">5</span>%</label>
                            <div id="slider-brightness" class="slider slider-info shor" style=""></div>
                        </div>

                        <div id="control-rgb" class="col-xs-12 col-sm-12 col-md-4">

                            <input id="control-rgb-input" type="text" data-wheelcolorpicker="" data-wcp-mobile="true" data-wcp-mobileWidth="500" data-wcp-live="false" data-wcp-sliders="w" data-wcp-hideKeyboard="true" data-wcp-snap="true" data-wcp-layout="block">
                        </div>

                        <div id="control-modes" class="col-xs-12 col-sm-12 col-md-12">

                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="seven_color_cross_fade">seven_color_cross_fade</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="red_gradual_change">red_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="green_gradual_change">green_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="blue_gradual_change">blue_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="yellow_gradual_change">yellow_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="cyan_gradual_change">cyan_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="purple_gradual_change">purple_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="white_gradual_change">white_gradual_change</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="red_green_cross_fade">red_green_cross_fade</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="red_blue_cross_fade">red_blue_cross_fade</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="green_blue_cross_fade">green_blue_cross_fade</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="seven_color_strobe_flash">seven_color_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="red_strobe_flash">red_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="green_strobe_flash">green_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="blue_stobe_flash">blue_stobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="yellow_strobe_flash">yellow_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="cyan_strobe_flash">cyan_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="purple_strobe_flash">purple_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="white_strobe_flash">white_strobe_flash</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="seven_color_jumping">seven_color_jumping</a>
                            <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" id="rgb_jumping">rgb_jumping</a>

                        </div>

                        <div id="debug" class="col-xs-12">


                            <form class="form-inline">

                                <div class="form-group">
                                    <label class="control-label" for="state-power">Power</label>
                                    <input type="text" class="form-control" id="state-power" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-red">R</label>
                                    <input type="text" class="form-control" id="state-red" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-green">G</label>
                                    <input type="text" class="form-control" id="state-green" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-blue">B</label>
                                    <input type="text" class="form-control" id="state-blue" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-bright">Brightness</label>
                                    <input type="text" class="form-control" id="state-bright" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-color">Color</label>
                                    <input type="text" class="form-control" id="state-color" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-ww">WW</label>
                                    <input type="text" class="form-control" id="state-ww" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-ww_level">WW %</label>
                                    <input type="text" class="form-control" id="state-ww_level" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-mode">Mode</label>
                                    <input type="text" class="form-control" id="state-mode" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-pattern">Pattern</label>
                                    <input type="text" class="form-control" id="state-pattern" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-delay">Delay</label>
                                    <input type="text" class="form-control" id="state-delay" size="8" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-speed">Speed</label>
                                    <input type="text" class="form-control" id="state-speed" size="8" />
                                </div>


                            </form>


                        </div>

                    </div>
                </div>

            </div>

        </div>

    </div>


    <!--    <span class="btn btn-material-deeppurple" onclick="javascript:$.snackbar({content: '<b>ERROR</b>',class:'error'});">Create and show a snackbar.</span>-->

    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        (function () {

            var $button = $("<div id='source-button' class='btn btn-primary btn-xs'>&lt; &gt;</div>").click(function () {
                var index = $('.bs-component').index($(this).parent());
                $.get(window.location.href, function (data) {
                    var html = $(data).find('.bs-component').eq(index).html();
                    html = cleanSource(html);
                    $("#source-modal pre").text(html);
                    $("#source-modal").modal();
                })

            });

            $('.bs-component [data-toggle="popover"]').popover();
            $('.bs-component [data-toggle="tooltip"]').tooltip();

            $(".bs-component").hover(function () {
                $(this).append($button);
                $button.show();
            }, function () {
                $button.hide();
            });

            function cleanSource(html) {
                var lines = html.split(/\n/);

                lines.shift();
                lines.splice(-1, 1);

                var indentSize = lines[0].length - lines[0].trim().length,
                    re = new RegExp(" {" + indentSize + "}");

                lines = lines.map(function (line) {
                    if (line.match(re)) {
                        line = line.substring(indentSize);
                    }

                    return line;
                });

                lines = lines.join("\n");

                return lines;
            }

            $(".icons-material .icon").each(function () {
                $(this).after("<br><br><code>" + $(this).attr("class").replace("icon ", "") + "</code>");
            });

        })();
    </script>

    <script src="js/ripples.min.js"></script>
    <script src="js/material.min.js"></script>
    <script src="js/wNumb.js"></script>
    <script src="js/snackbar.min.js"></script>
    <script src="js/nouislider.js"></script>
    <script src="js/jquery.wheelcolorpicker.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var snackBarOptions = {
            content: "default message",
            timeout: 5000,
            htmlAllowed: true,
            onClose: function () {} // callback
        };

        //Number formatter
        var decimalFormat = wNumb({
            decimals: 0
        });

        //Ranges
        var brightnessRange = {
            'min': 5,
            'max': 100
        };

        //throttle function for limiting event calls
        //prevents packet spam 
        function throttle(func, interval) {
            var lastCall = 0;
            return function () {
                var now = Date.now();
                if (lastCall + interval < now) {
                    lastCall = now;
                    return func.apply(this, arguments);
                }
            };
        }

        var hold = false;

        var socket = io();

        socket.on('connect', () => {
            $("#connect-ok").show()
            $("#connect-remote").hide()
            $("#connect-off").hide()
            $("#connect-warn").hide()
            console.log('Connected')

            $.snackbar({
                content: '<b>SOCKET:</b> Connected to node server!',
                class: 'success',
                timeout: 5000
            });
        })

        socket.on('disconnect', () => {
            $("#connect-ok").hide()
            $("#connect-remote").hide()
            $("#connect-off").show()
            $("#connect-warn").show()
            console.log('Disonnected')

            $.snackbar({
                content: '<b>ERROR:</b> Socket disconnected.<br>Please check node server for errors.',
                class: 'error',
                timeout: 5000
            });
        })

        //Document.ready
        $(function () {

            //Template init
            $.material.init();

            //Color wheel init
            $(function () {
                $('.colorpicker').wheelColorPicker({
                    'mobile': true
                });
            });

            //Init device values
            socket.emit('check-state', {
                'device': '192.168.1.50'
            })
            setInterval(() => {
                if (!hold) socket.emit('check-state', {
                    'device': '192.168.1.50'
                })
            }, 1000)


            //Slider init
            var brightnessSlider = document.getElementById('slider-brightness');

            noUiSlider.create(brightnessSlider, {
                animate: true,
                animationDuration: 300,
                start: 5,
                step: 5,
                connect: 'lower',
                range: brightnessRange,
                format: decimalFormat
            });

            //Dimmer brightness event. TODO: Make dynamic also
            brightnessSlider.noUiSlider.on('slide', function () {
                value = brightnessSlider.noUiSlider.get();
                $("#state-bright").val(value);
                $("#level-brightness").html(value);

                rgb = calcRgbBrightness(value, $("#control-rgb-input").wheelColorPicker('getValue', 'rgb'));

                console.log(value, rgb)
                    //                console.log(calcBrightness(value, $("#state-red").val()),calcBrightness(value, $("#state-green").val()),calcBrightness(value, $("#state-blue").val()))
                    //                console.log(r,g,b)
                    //Send socket here
                socket.emit('command', {
                    'cmd': 'brightness',
                    'value': rgb,
                    'device': '192.168.1.50'

                }, function (data) {
                    console.log(data);
                });
            });

            //Prevent the client from auto-refreshing state 
            //while sliding to reduce spam
            brightnessSlider.noUiSlider.on('start', function () {
                hold = true;
                socket.emit('hold', {
                    'value': true,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            });

            //Resume the client auto-refreshing state after sliding
            brightnessSlider.noUiSlider.on('end', function () {
                hold = false;
                socket.emit('hold', {
                    'value': false,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            });

            $('#control-rgb-input').on('sliderup', throttle(function () {
                hold = false;
                socket.emit('hold', {
                    'value': false,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            }, 50));

            $('#control-rgb-input').on('sliderdown', function () {
                hold = true;
                socket.emit('hold', {
                    'value': true,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            });
            $('#control-rgb-input').on('focus', function () {
                console.log("focus")

                // console.log($(this).wheelColorPicker('getValue', 'rgb'))
            });
            $('#control-rgb-input').on('blur', function () {
                console.log("blur")
                    //  console.log($(this).wheelColorPicker('getValue', 'rgb'))
            });
            $('#control-rgb-input').on('change', function () {

                console.log($(this).wheelColorPicker('getValue', 'rgb'))

            });
            $('#control-rgb-input').on('slidermove', throttle(function () {
                console.log($(this).wheelColorPicker('getValue', 'rgb'))
                value = $(this).wheelColorPicker('getValue', 'rgb');
                console.log("send rgb")

                socket.emit('command', {
                    'cmd': 'rgb',
                    'value': value,
                    'device': '192.168.1.50'

                }, function (data) {
                    console.log(data);
                });
                //                $('#event-color').val($(this).wheelColorPicker('getValue', 'rgb'));
            }, 50));

            //Power button event. TODO: Make dynamic.
            $('#btn-power').on("click", function () {
                console.log($(this).find("#btn-power-value").is(":checked"))
                if ($(this).find("#btn-power-value").is(":checked")) {
                    console.log("Is On, will turn off")

                    turnOff(this, brightnessSlider)

                    socket.emit('command', {
                        'cmd': 'power',
                        'value': 'off',
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });

                } else {
                    console.log("Is off, will turn on")
                    turnOn(this, brightnessSlider)
                    socket.emit('command', {
                        'cmd': 'power',
                        'value': 'on',
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });

                }
            })

            //             
            //            $(".shor").noUiSlider({
            //                start: 0,
            //                connect: "lower",
            //                tooltips: [true,  wNumb({ decimals: 1 }) ],
            //                range: {
            //                    min: 0,
            //                    max: 100
            //                }
            //            });
            //
            //            $(".svert").noUiSlider({
            //                orientation: "vertical",
            //                start: 40,
            //                connect: "lower",
            //                range: {
            //                    min: 0,
            //                    max: 100
            //                }
            //            });
        });

        //UI function when device is On
        function turnOn(target, brightnessSlider) {
            $(target).trigger("focusout")
            $(target).find("#btn-power-value").prop('checked', true);
            $(target).removeClass("btn-off")
            $(target).addClass("btn-on")


            parent = $(target).parentsUntil("device-container")
            console.log($(parent).find("#state-bright").val())

            //Enable brightness dimmer and other controls.
            brightnessSlider.removeAttribute('disabled');
            brightnessSlider.noUiSlider.set($(parent).find("#state-bright").val());
        }


        //UI function when device is Off
        function turnOff(target, brightnessSlider) {
            $(target).trigger("focusout")
            $(target).find("#btn-power-value").prop('checked', false);
            $(target).removeClass("btn-on")
            $(target).addClass("btn-off")
                //Disable brightness dimmer and other controls.
            brightnessSlider.setAttribute('disabled', true);
            brightnessSlider.noUiSlider.set(0)
        }

        function calcPercentage(value) {
            if (value > 255) value = 255
            if (value < 15) value = 15

            //returns 0 - 100
            return Math.round(parseInt((value * 100) / 255))
        }

        //get Brightness Value from RGB
        function getBrightness(r, g, b) {
            if (r >= g && r >= b) {
                max = r
            } else if (g >= r && g >= b) {
                max = g
            } else if (b >= r && b >= g) {
                max = b
            } else if (r == g && r == b) {
                max = r
            }

            if (max > 255) max = 255
            if (max < 15) max = 15

            //returns 0 - 100
            return Math.round(parseInt((max * 100) / 255))
        }

        //calculate Brightness value
        function calcRgbBrightness(value, rgb) {
            if (value > 100)
                value = 100
            if (value < 0)
                value = 0

            var rgbarr = /([0-9]{1,3}),([0-9]{1,3}),([0-9]{1,3})/g.exec(rgb)
            r = rgbarr[1]
            g = rgbarr[2]
            b = rgbarr[3]

            console.log(r, g, b, "|", r * value, g * value, b * value)

            //returns 0 - 255
            r = parseInt((r * value) / (100))
            g = parseInt((g * value) / (100))
            b = parseInt((b * value) / (100))

            return {
                r: r,
                g: g,
                b: b
            }
        }



        socket.on('state', (data) => {
            console.log(data);
            $("#192_168_1_50").find("#state-power").val(data.power)
            $("#192_168_1_50").find("#state-red").val(data.r)
            $("#192_168_1_50").find("#state-green").val(data.g)
            $("#192_168_1_50").find("#state-blue").val(data.b)
            $("#192_168_1_50").find("#state-bright").val(getBrightness(data.r, data.g, data.b))
            $("#192_168_1_50").find("#level-brightness").html(getBrightness(data.r, data.g, data.b))
            $("#192_168_1_50").find("#state-color").val("#" + data.r.toString(16) + data.g.toString(16) + data.b.toString(16))
            $("#192_168_1_50").find("#state-ww").val(data.ww)
            $("#192_168_1_50").find("#state-ww_level").val(data.ww_level)
            $("#192_168_1_50").find("#state-mode").val(data.mode)
            $("#192_168_1_50").find("#state-pattern").val(data.pattern_id)
            $("#192_168_1_50").find(".btn-pattern").removeClass("btn-info")
            $("#192_168_1_50").find(".btn-pattern#" + data.pattern_id).addClass("btn-info")
            $("#192_168_1_50").find("#state-delay").val(data.delay)
            $("#192_168_1_50").find("#state-speed").val(data.speed)

            if (data.power == "ON") {
                turnOn($('#192_168_1_50').find("#btn-power-value"), $('#192_168_1_50').find("#slider-brightness")[0])
            } else {
                turnOff($('#192_168_1_50').find("#btn-power-value"), $('#192_168_1_50').find("#slider-brightness")[0])
            }
        })
    </script>



</body>

</html>