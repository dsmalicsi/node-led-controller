<!DOCTYPE HTML>
<!-- 
 Copyright (C) 2016 Daryll Malicsi,
 LICENSE at https://github.com/dsmalicsi/node-led-controller/blob/master/LICENSE.md
-->
<html>

<head>
    <title>Node-Led-Controller by @dsmalicsi</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">


    <title>Bootstrap Material</title>

    <!-- Material Design fonts -->
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Material Design -->
    <link href="css/bootstrap-material-design.css" rel="stylesheet">
    <link href="css/ripples.min.css" rel="stylesheet">
    <link href="css/wheelcolorpicker.css" rel="stylesheet">
    <link href="css/wheelcolorpicker.dark.css" rel="stylesheet">
    <link href="css/snackbar.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        .snackbar.success {
            background-color: #5cb85c;
        }
        
        .snackbar.error {
            background-color: #f55549;
        }
        
        .snackbar.info {
            background-color: #0fb2fc;
        }
        
        .noUi-tooltip {
            margin-top: 18px;
        }
        
        .panel-body {
            background-color: #424242 !important;
        }
        
        a#btn-power.btn-on {
            background-color: #03a9f4 !important;
        }
        
        a#btn-power.btn-off {
            background-color: #303030 !important;
        }
        
        .panel-heading {
                        min-height: 60px;
        }
        
        .device-info {
            font-size:18px !important;
            line-height: 40px;
            float:left;
        }
        
        .device-info .material-icons {
            font-size: 22px !important;
            line-height: 40px;
            vertical-align: bottom;
        }
        
        .jQWCP-wWidget.jQWCP-block {
            border: 0px;
            background: 0px;
            box-shadow: none;
        }
        
        .form-inline input.form-control {
            display: block;
            color: #FFF !important;
        }
        /*
        .togglebutton {
            margin-left: 5px;
        }
*/
     </style>

</head>

<body class="inverse">

    <div class="container">
        <div class="page-header" id="banner">
            <div class="row">
                <div class="col-sm-12">
                    <h1>node-led-controller</h1>
                    <p class="lead">This is the front-end panel of the <a href="https://nodejs.org/en/">Node.js</a> client for controlling and programming LED Lights connected to a <a href="http://nodemcu.com/index_en.html">NodeMCU</a> WiFi chipset. This panel uses <a href="http://socket.io/">Socket.io</a> as a bridge between the user and the devices for real-time event-based communication.</p>
                </div>

            </div>
        </div>

        <div class="row device-container" data-device="192.168.1.50">

            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="device-info">
                            <span>
                                <i id="connect-ok" class="material-icons text-success">wifi</i> 
                                <i id="connect-remote" class="material-icons text-success">wb_cloudy</i> 
                                <i id="connect-warn" class="material-icons text-warning">perm_scan_wifi</i> 
                                <i id="connect-off" class="material-icons text-muted">signal_wifi_off</i>  
                                <b>DEVICE 1</b> (<span id="device-ip">192.168.1.50</span>:<span id="device-port">5577</span>)
                            </span>
                        </div>
                             
                        <div class="btn-group-sm pull-right">
                            <a href="javascript:void(0)" id="btn-power" class="btn btn-info btn-fab btn-off" data-device="192.168.1.50">
                                <i class="material-icons">power_settings_new</i>
                                <input id="btn-power-value" name="btn-power-value" type="checkbox" class="hidden" data-device="192.168.1.50" checked>

                            </a>
                        </div>
                        
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            
                            <div id="control-brightness" class="col-xs-12 col-sm-6">
                                <label>Brightness: <span id="level-brightness" data-device="192.168.1.50">5</span>%</label>
                                <div id="slider-brightness" class="slider slider-info slider-brightness shor" data-device="192.168.1.50" style=""></div>
                            </div>

                           
                            <div id="control-speed" class="col-xs-12 col-sm-6">
                                <label>Pattern Speed: <span id="level-speed" data-device="192.168.1.50">0</span>%</label>
                                <div id="slider-speed" class="slider slider-info slider-speed shor" style="" data-device="192.168.1.50" ></div>
                            </div>
                        </div>
                        
                        
                        
                        <ul class="nav nav-tabs nav-justified">
                          <li class="active"><a data-toggle="tab" href="#colors">Solid Color</a></li>
                          <li><a data-toggle="tab" href="#patterns">Patterns</a></li>
                          <li><a data-toggle="tab" href="#a">#</a></li>
                        </ul>

                        <div class="tab-content">
                          <div id="colors" class="tab-pane fade in active">
                            
                             
                            <div id="control-rgb" class="col-xs-12 col-sm-12 col-md-3">
<!--                                <label>RGB </label><br/>-->
                                <input id="control-rgb-input" type="text" data-wheelcolorpicker="" data-wcp-mobile="true" data-wcp-mobileWidth="500" data-wcp-live="false" data-wcp-sliders="w" data-wcp-hideKeyboard="true" data-wcp-snap="true" data-wcp-layout="block" data-device="192.168.1.50" >
                            </div>

                          </div>
                          <div id="patterns" class="tab-pane fade">
                            <h3>Patterns</h3>

                            <div id="control-modes" class="col-xs-12 col-sm-12 col-md-12" data-device="192.168.1.50">

                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="seven_color_cross_fade">seven_color_cross_fade</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="red_gradual_change">red_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="green_gradual_change">green_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="blue_gradual_change">blue_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="yellow_gradual_change">yellow_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="cyan_gradual_change">cyan_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="purple_gradual_change">purple_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="white_gradual_change">white_gradual_change</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="red_green_cross_fade">red_green_cross_fade</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="red_blue_cross_fade">red_blue_cross_fade</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="green_blue_cross_fade">green_blue_cross_fade</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="seven_color_strobe_flash">seven_color_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="red_strobe_flash">red_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="green_strobe_flash">green_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="blue_stobe_flash">blue_stobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="yellow_strobe_flash">yellow_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="cyan_strobe_flash">cyan_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="purple_strobe_flash">purple_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="white_strobe_flash">white_strobe_flash</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="seven_color_jumping">seven_color_jumping</a>
                                <a href="javascript:void(0)" class="btn btn-raised btn-default btn-pattern" data-device="192.168.1.50" id="rgb_jumping">rgb_jumping</a>

                            </div>
                          </div>
                          <div id="a" class="tab-pane fade">
                            <h3>#</h3>
                            <div id="debug" class="col-xs-12">


                            <form class="form-inline">

                                <div class="form-group">
                                    <label class="control-label" for="state-power">Power</label>
                                    <input type="text" class="form-control" id="state-power" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-red">R</label>
                                    <input type="text" class="form-control" id="state-red" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-green">G</label>
                                    <input type="text" class="form-control" id="state-green" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-blue">B</label>
                                    <input type="text" class="form-control" id="state-blue" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-bright">Brightness</label>
                                    <input type="text" class="form-control" id="state-bright" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-color">Color</label>
                                    <input type="text" class="form-control" id="state-color" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-ww">WW</label>
                                    <input type="text" class="form-control" id="state-ww" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-ww_level">WW %</label>
                                    <input type="text" class="form-control" id="state-ww_level" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-mode">Mode</label>
                                    <input type="text" class="form-control" id="state-mode" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-pattern">Pattern</label>
                                    <input type="text" class="form-control" id="state-pattern" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-delay">Delay</label>
                                    <input type="text" class="form-control" id="state-delay" size="8" data-device="192.168.1.50" />
                                </div>
                                <div class="form-group">
                                    <label class="control-label" for="state-speed">Speed</label>
                                    <input type="text" class="form-control" id="state-speed" size="8" data-device="192.168.1.50" />
                                </div>


                            </form>


                        </div>

                          </div>
                        </div>
                        
                        
                      
                        
                        

                        
                    </div>
                </div>

            </div>

        </div>

    </div>


    <!--    <span class="btn btn-material-deeppurple" onclick="javascript:$.snackbar({content: '<b>ERROR</b>',class:'error'});">Create and show a snackbar.</span>-->

    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        (function () {

            var $button = $("<div id='source-button' class='btn btn-primary btn-xs'>&lt; &gt;</div>").click(function () {
                var index = $('.bs-component').index($(this).parent());
                $.get(window.location.href, function (data) {
                    var html = $(data).find('.bs-component').eq(index).html();
                    html = cleanSource(html);
                    $("#source-modal pre").text(html);
                    $("#source-modal").modal();
                })

            });

            $('.bs-component [data-toggle="popover"]').popover();
            $('.bs-component [data-toggle="tooltip"]').tooltip();

            $(".bs-component").hover(function () {
                $(this).append($button);
                $button.show();
            }, function () {
                $button.hide();
            });

            function cleanSource(html) {
                var lines = html.split(/\n/);

                lines.shift();
                lines.splice(-1, 1);

                var indentSize = lines[0].length - lines[0].trim().length,
                    re = new RegExp(" {" + indentSize + "}");

                lines = lines.map(function (line) {
                    if (line.match(re)) {
                        line = line.substring(indentSize);
                    }

                    return line;
                });

                lines = lines.join("\n");

                return lines;
            }

            $(".icons-material .icon").each(function () {
                $(this).after("<br><br><code>" + $(this).attr("class").replace("icon ", "") + "</code>");
            });

        })();
    </script>

    <script src="js/ripples.min.js"></script>
    <script src="js/material.min.js"></script>
    <script src="js/wNumb.js"></script>
    <script src="js/snackbar.min.js"></script>
    <script src="js/nouislider.js"></script>
    <script src="js/jquery.wheelcolorpicker.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var snackBarOptions = {
            content: "default message",
            timeout: 5000,
            htmlAllowed: true,
            onClose: function () {} // callback
        };

        //Number formatter
        var decimalFormat = wNumb({
            decimals: 0
        });

        //Ranges
        var brightnessRange = {
            'min': 5,
            'max': 100
        };

        //throttle function for limiting event calls
        //prevents packet spam 
        function throttle(func, interval) {
            var lastCall = 0;
            return function () {
                var now = Date.now();
                if (lastCall + interval < now) {
                    lastCall = now;
                    return func.apply(this, arguments);
                }
            };
        }

        var hold = false;
        var refresher = {};
        var socket = io();

        socket.on('connect', () => {
            $("#connect-ok").show()
            $("#connect-remote").hide()
            $("#connect-off").hide()
            $("#connect-warn").hide()
            console.log('Connected')

            $.snackbar({
                content: '<b>SOCKET:</b> Connected to node server!',
                class: 'success',
                timeout: 5000
            });
        })

        socket.on('disconnect', () => {
            $("#connect-ok").hide()
            $("#connect-remote").hide()
            $("#connect-off").show()
            $("#connect-warn").show()
            console.log('Disonnected')

            $.snackbar({
                content: '<b>ERROR:</b> Socket disconnected.<br>Please check node server for errors.',
                class: 'error',
                timeout: 5000
            });
        })

        //Document.ready
        $(function () {

            //Template init
            $.material.init();

            //Color wheel init
            $(function () {
                $('.colorpicker').wheelColorPicker({
                    'mobile': true
                });
            });

            //Init device values
            socket.emit('check-state', {
                'device': '192.168.1.50'
            })
            
            //socket refresher to get updated device values
            
            refresher = {
                running: false,
                iv: 1000,
                timeout: false,
                cb : function(){},
                start : function(cb,iv){
                    var elm = this;
                    clearInterval(this.timeout);
                    this.running = true;
                    if(cb) this.cb = cb;
                    if(iv) this.iv = iv;
                    this.timeout = setTimeout(function(){elm.execute(elm)}, this.iv);
                },
                execute : function(e){
                    if(!e.running) return false;
                    e.cb();
                    e.start();
                },
                stop : function(){
                    this.running = false;
                },
                set_interval : function(iv){
                    clearInterval(this.timeout);
                    this.start(false, iv);
                }
            };
            
            refresher.start(() => {
                if (!hold) socket.emit('check-state', {
                    'device': '192.168.1.50'
                })
            }, 1000)


            //Slider init
             
            var brightnessSliders = $(".slider-brightness");
            var speedSliders = $(".slider-speed");
            
            
            
            console.log(brightnessSliders)
            console.log(brightnessSliders.length)
//            console.log($(".slider-brightness"))
//            console.log($(".slider-brightness")[0])
//            console.log($(".slider-brightness")[1])
            
             for (var i = 0; i < brightnessSliders.length; i++) { 
                
                brightnessSlider = brightnessSliders[i]
                
                console.log("i",i)
                
                if(!brightnessSlider.noUiSlider){
                     noUiSlider.create(brightnessSlider, {
                        animate: true,
                        animationDuration: 300,
                        start: 5,
                        step: 5,
                        connect: 'lower',
                        range: brightnessRange,
                        format: decimalFormat
                    });

                }
                
                 
                //Dimmer brightness event. TODO: Make dynamic also
                brightnessSlider.noUiSlider.on('slide', function () {
                    value = brightnessSlider.noUiSlider.get();
                    $("#state-bright").val(value);
                    $("#level-brightness").html(value);

                    rgb = calcRgbBrightness(value, $("#control-rgb-input").wheelColorPicker('getValue', 'rgb'));

                        //Send socket here
                    socket.emit('command', {
                        'cmd': 'brightness',
                        'value': rgb,
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });
                });

                
            }
            
            for (var i = 0; i < speedSliders.length; i++) {
                
                speedSlider = speedSliders.get(i)
                
                noUiSlider.create(speedSlider, {
                    animate: true,
                    animationDuration: 300,
                    start: 0,
                    step: 5,
                    connect: 'lower',
                    range: {
                        'min': 0,
                        'max': 100
                    },
                    format: decimalFormat
                });

                //Speed slider event. TODO: Make dynamic also
                speedSlider.noUiSlider.on('slide', function () {
                    value = speedSlider.noUiSlider.get();
                    $("#state-speed").val(value);
                    $("#level-speed").html(value);

                    pattern_name = $(".btn-pattern.btn-info").attr("id")
                    console.log(pattern_name)
                    socket.emit('command', {
                        'cmd': 'pattern',
                        'value': {'speed':speedSlider.noUiSlider.get(),'pattern':pattern_name},
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });
                });
                
            }
           
            //Prevent the client from auto-refreshing state 
            //while sliding to reduce spam
            var sliders = $(".slider")
          
            for(var i = 0; i < sliders.length; i++) {
                
                //has Uncaught TypeError. Not sure why yet.
                sliders[i].noUiSlider.on('start', function () {
                    console.log("holding")
                    hold = true;
                    socket.emit('hold', {
                        'value': true,
                        'device': '192.168.1.50'
                    }, function (data) {
                        console.log(data);
                    });
                });

                //Resume the client auto-refreshing state after sliding
                sliders[i].noUiSlider.on('end', function () {
                    hold = false;
                    socket.emit('hold', {
                        'value': false,
                        'device': '192.168.1.50'
                    }, function (data) {
                        console.log(data);
                    });
                });
                
            }
          
           


            $('#control-rgb-input').on('sliderup', throttle(function () {
                hold = false;
                socket.emit('hold', {
                    'value': false,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            }, 50));

            $('#control-rgb-input').on('sliderdown', function () {
                hold = true;
                socket.emit('hold', {
                    'value': true,
                    'device': '192.168.1.50'
                }, function (data) {
                    console.log(data);
                });
            });
            $('#control-rgb-input').on('focus', function () {
                console.log("focus")

                // console.log($(this).wheelColorPicker('getValue', 'rgb'))
            });
            $('#control-rgb-input').on('blur', function () {
                console.log("blur")
                    //  console.log($(this).wheelColorPicker('getValue', 'rgb'))
            });
            $('#control-rgb-input').on('change', function () {

                console.log($(this).wheelColorPicker('getValue', 'rgb'))

            });
            $('#control-rgb-input').on('slidermove', throttle(function () {
                console.log($(this).wheelColorPicker('getValue', 'rgb'))
                value = $(this).wheelColorPicker('getValue', 'rgb');
                console.log("send rgb")

                socket.emit('command', {
                    'cmd': 'rgb',
                    'value': value,
                    'device': '192.168.1.50'

                }, function (data) {
                    console.log(data);
                });
                //                $('#event-color').val($(this).wheelColorPicker('getValue', 'rgb'));
            }, 50));

            //Power button event. TODO: Make dynamic.
            $('#btn-power').on("click", function () {
                console.log($(this).find("#btn-power-value").is(":checked"))
                if ($(this).find("#btn-power-value").is(":checked")) {
                    console.log("Is On, will turn off")

                    turnOff($(this).data("device"))

                    socket.emit('command', {
                        'cmd': 'power',
                        'value': 'off',
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });

                } else {
                    console.log("Is off, will turn on")
                    turnOn($(this).data("device"))
                    socket.emit('command', {
                        'cmd': 'power',
                        'value': 'on',
                        'device': '192.168.1.50'

                    }, function (data) {
                        console.log(data);
                    });

                }
            })
            
            $(".btn-pattern").on("click", function () {
                pattern_name = $(this).attr("id")
                console.log(pattern_name)
                socket.emit('command', {
                    'cmd': 'pattern',
                    'value': {'speed':speedSlider.noUiSlider.get(),'pattern':pattern_name},
                    'device': '192.168.1.50'

                }, function (data) {
                    console.log(data);
                });
            })


        });

        //UI function when device is On
        function turnOn(device) {
            
            btnPower = $("#btn-power[data-device='"+device+"']")
            brightnessSlider = $("#slider-brightness[data-device='"+device+"']")[0]

            $("#btn-power-value[data-device='"+device+"']").prop('checked', true);
            btnPower.trigger("focusout")
            btnPower.removeClass("btn-off")
            btnPower.addClass("btn-on")
             
            //Enable brightness dimmer and other controls.
            brightnessSlider.removeAttribute('disabled');
            brightnessSlider.noUiSlider.set($("#state-bright[data-device='"+device+"']").val());
            $(".btn-pattern[data-device='"+device+"']").removeClass("disabled")


        }


        //UI function when device is Off
        function turnOff(device) {
            btnPower = $("#btn-power[data-device='"+device+"']")
            brightnessSlider = $("#slider-brightness[data-device='"+device+"']")[0]
            
            $("#btn-power-value[data-device='"+device+"']").prop('checked', false);
            btnPower.trigger("focusout")
            btnPower.removeClass("btn-on")
            btnPower.addClass("btn-off")
            
            //Disable brightness dimmer and other controls.
            brightnessSlider.setAttribute('disabled', true);
            brightnessSlider.noUiSlider.set(0)
            $(".btn-pattern[data-device='"+device+"']").addClass("disabled")


        }

        function calcPercentage(value) {
            if (value > 255) value = 255
            if (value < 15) value = 15

            //returns 0 - 100
            return Math.round(parseInt((value * 100) / 255))
        }

        //get Brightness Value from RGB
        function getBrightness(r, g, b) {
            if (r >= g && r >= b) {
                max = r
            } else if (g >= r && g >= b) {
                max = g
            } else if (b >= r && b >= g) {
                max = b
            } else if (r == g && r == b) {
                max = r
            }

            if (max > 255) max = 255
            if (max < 15) max = 15

            //returns 0 - 100
            return Math.round(parseInt((max * 100) / 255))
        }

        //calculate Brightness value
        function calcRgbBrightness(value, rgb) {
            if (value > 100)
                value = 100
            if (value < 0)
                value = 0

            var rgbarr = /([0-9]{1,3}),([0-9]{1,3}),([0-9]{1,3})/g.exec(rgb)
            r = rgbarr[1]
            g = rgbarr[2]
            b = rgbarr[3]

            console.log(r, g, b, "|", r * value, g * value, b * value)

            //returns 0 - 255
            r = parseInt((r * value) / (100))
            g = parseInt((g * value) / (100))
            b = parseInt((b * value) / (100))

            return {
                r: r,
                g: g,
                b: b
            }
        }



        socket.on('state', (data) => {
            var device = '192.168.1.50'
                console.log($("#level-brightness[data-device='"+device+"']"));

            $("#state-power[data-device='"+device+"']").val(data.power)
            $("#state-red[data-device='"+device+"']").val(data.r)
            $("#state-green[data-device='"+device+"']").val(data.g)
            $("#state-blue[data-device='"+device+"']").val(data.b)
            $("#state-bright[data-device='"+device+"']").val(getBrightness(data.r, data.g, data.b))
            $("#level-brightness[data-device='"+device+"']").html(getBrightness(data.r, data.g, data.b))
            $("#state-color[data-device='"+device+"']").val("#" + data.r.toString(16) + data.g.toString(16) + data.b.toString(16))
            $("#state-ww[data-device='"+device+"']").val(data.ww)
            $("#state-ww_level[data-device='"+device+"']").val(data.ww_level)
            $("#state-mode[data-device='"+device+"']").val(data.mode)
            $("#state-pattern[data-device='"+device+"']").val(data.pattern_id)
            $(".btn-pattern[data-device='"+device+"']").removeClass("btn-info")
            $(".btn-pattern[data-device='"+device+"']#" + data.pattern_id).addClass("btn-info")
            $("#state-delay[data-device='"+device+"']").val(data.delay)
            $("#state-speed[data-device='"+device+"']").val(data.speed)
            
            $(".slider[data-device='"+device+"']").css('background-color','rgb('+data.r+','+data.g+','+data.b+')')
            
            //Change refresh interval depending on pattern
            if (data.pattern_id == "color") {
                refresher.set_interval(5000);
                console.log("color")
            } else if (data.power != "OFF"){
                refresher.set_interval(150);
            }

            //Update UI
            if (data.power == "ON") {
                turnOn(device)
                if (data.pattern_id != "color") {
                    $("#slider-brightness[data-device='"+device+"']")[0].setAttribute("disabled", true)
                    $("#slider-speed[data-device='"+device+"']")[0].removeAttribute("disabled")
                } else if (data.pattern_id == "color") {
                    $("#slider-speed[data-device='"+device+"']")[0].setAttribute("disabled", true)
                    $("#slider-brightness[data-device='"+device+"']")[0].removeAttribute("disabled")

                }
            } else {
                refresher.set_interval(60000);
                turnOff(device)
            }
        })
    </script>



</body>

</html>